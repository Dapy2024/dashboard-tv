name: Screenshot Dashboards Dash
on:
  schedule:
    - cron: '*/5 * * * *' 
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  take-screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar herramientas
        run: |
          pip install playwright==1.40.0
          pip install shot-scraper
          shot-scraper install

      - name: Capturar Dashboard 1 (Modo Presentación Robust)
        run: |
          shot-scraper shot "https://lookerstudio.google.com/u/1/reporting/d2c2a5e0-dcfe-4633-b141-d4d0179fcae4/page/p_h4ubm1dzyd" \
          --width 1920 --height 1080 \
          --wait 40000 \
          --javascript "
            new Promise(async (resolve) => {
              const wait = (ms) => new Promise(r => setTimeout(r, ms));
              console.log('Buscando menú de opciones...');

              // ESTRATEGIA 1: Buscar por la clase interna exacta de Looker Studio
              let dots = document.querySelector('.lego-header-more-menu-button');

              // ESTRATEGIA 2: Si falla, buscar por icono (Google usa 'more_vert')
              if (!dots) {
                 const icons = Array.from(document.querySelectorAll('i.google-material-icons'));
                 dots = icons.find(el => el.innerText === 'more_vert')?.parentElement;
              }

              if (dots) {
                console.log('Botón encontrado. Click!');
                // Forzamos el clic en el centro del elemento
                const rect = dots.getBoundingClientRect();
                const clickEvent = new MouseEvent('click', {
                  view: window, bubbles: true, cancelable: true,
                  clientX: rect.left + rect.width / 2,
                  clientY: rect.top + rect.height / 2
                });
                dots.dispatchEvent(clickEvent);
                
                await wait(2000); // Esperar menú

                // BUSCAR BOTÓN 'PRESENTAR' (Icono de pantalla o texto)
                // Buscamos cualquier item de menú que tenga el icono de 'present_to_all' o texto 'Present'
                const menuItems = Array.from(document.querySelectorAll('.goog-menuitem'));
                const presentBtn = menuItems.find(el => {
                   return el.innerText.match(/Present/i) || el.innerHTML.includes('present_to_all');
                });

                if (presentBtn) {
                  console.log('Opción Presentar encontrada. Click!');
                  presentBtn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
                  await wait(10000); // Tiempo para cargar pantalla completa
                } else {
                  console.log('No se vio el botón Presentar en el menú');
                }
              } else {
                console.log('No se encontraron los tres puntitos por clase o icono.');
              }
              resolve();
            });
          " \
          -o dashboard1.png

      - name: Capturar Dashboard 2 (Modo Presentación Robust)
        run: |
          shot-scraper shot "https://lookerstudio.google.com/u/1/reporting/d2c2a5e0-dcfe-4633-b141-d4d0179fcae4/page/p_l9do7lezyd" \
          --width 1920 --height 1080 \
          --wait 40000 \
          --javascript "
            new Promise(async (resolve) => {
              const wait = (ms) => new Promise(r => setTimeout(r, ms));
              
              let dots = document.querySelector('.lego-header-more-menu-button');
              if (!dots) {
                 const icons = Array.from(document.querySelectorAll('i.google-material-icons'));
                 dots = icons.find(el => el.innerText === 'more_vert')?.parentElement;
              }

              if (dots) {
                const rect = dots.getBoundingClientRect();
                dots.dispatchEvent(new MouseEvent('click', {
                  view: window, bubbles: true, cancelable: true,
                  clientX: rect.left + rect.width / 2,
                  clientY: rect.top + rect.height / 2
                }));
                await wait(2000);

                const menuItems = Array.from(document.querySelectorAll('.goog-menuitem'));
                const presentBtn = menuItems.find(el => el.innerText.match(/Present/i) || el.innerHTML.includes('present_to_all'));

                if (presentBtn) {
                  presentBtn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
                  await wait(10000);
                }
              }
              resolve();
            });
          " \
          -o dashboard2.png

      - name: Guardar capturas y actualizar sitio
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dashboard1.png dashboard2.png
          git commit -m "Fix Click: Usando clase .lego-header-more-menu-button" || exit 0
          git push origin main
